== git

.switch/restore
[horizontal]
switch:: ブランチの操作
restore:: 編集したりステージに載せたファイルの操作

.switch/restore
|===
|操作 |従来のコマンド |新しいコマンド

|ブランチを切り替える
|`git checkout main`
|`git switch main`

|ブランチを作って切り替える
|`git checkout -b new-branch`
|`git switch -c new-branch`

|ファイルの変更を破棄する
|`git checkout -- file.txt`
|`git restore file.txt`

|全ファイルの変更を破棄する
|`git checkout .`
|`git restore .`

|ステージングを解除する
|`git reset HEAD file.txt`
|`git restore --staged file.txt`
|===

[source,bash]
.tag関係
----
# tag 作成
git tag v0.0.1 -m "message"
# tag 削除
git tag -d v0.0.1
# tag 一覧 (-n でメッセージの表示、数値でメッセージの行数を指定)
git tag --list
git tag --list -n3
# tag push (ブランチと一緒)
git push $remote v0.0.1
----

[source,bash]
.管理下にあるファイルを無視したい(update-index)
----
# merge, reset は処理する
git update-index --[no-]assume-unchanged $path
# merge, reset なども含む
git update-index --[no-]skip-worktree $path

# 設定確認
# assume-unchanged 対象は状態を小文字で表示
# skip-worktree 対象は状態を S と表示
git ls-files -v
----

[source,bash]
.リネームしても追随して差分を表示する
----
git diff -M
git diff --find-renames

# 類似性インデックスの閾値をパーセンテージで指定できる
git diff -M50%
----

[source,bash]
.古いコミットのファイルを別名でチェックアウトする
----
git show $COMMIT:$FILE > $NEW_FILENAME
git cat-file blob $COMMIT:$FILE > $NEW_FILENAME
----

[source,bash]
.別ディレクトリにチェックアウトして作業する
----
# 作業開始時に add して終了時に remove
# list で状態確認
# move でディレクトリの移動
# repair で不整合の修復(手動で作業ディレクトリを mv した場合など)
# prune でクリーンアップ(手動で作業ディレクトリを rm した場合など)
# lock で prune を抑止。 unlock で解除

git worktree add ../hotfix-dir hotfix
git worktree list
git worktree remove hotfix-dir
----

[source,bash]
.空コミット(初回も有効)
----
git commit --allow-empty -m "first commit"
----

[source,bash]
.git author の上書き
----
# 文字列で username と email を指定する
git commit --amend --author="username <user@example.com>"
----

[source,bash]
.差分のあるファイルを抽出してコピー
----
#!/bin/sh
DEST=pickup
rm -rf ${DEST}
mkdir ${DEST}
git diff --stat --name-only @^ @ | while read filepath; do
if [ -e "${filepath}" ]; then
  echo "[cp] ${filepath} to ${DEST}/fix/${filepath}"
  mkdir -p ${DEST}/org/`dirname ${filepath}`
  mkdir -p ${DEST}/fix/`dirname ${filepath}`
  cp -r "${filepath}" "${DEST}/fix/${filepath}"
else
  echo "[IGNORE] ${filepath}"
fi
done
----
